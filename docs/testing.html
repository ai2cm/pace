

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Testing &mdash; Pace  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="pace-util" href="util/index.html" />
    <link rel="prev" title="Docker" href="docker.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Pace
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="fv3.html">FV3</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="util/index.html">pace-util</a></li>
<li class="toctree-l1"><a class="reference internal" href="physics/index.html">pace-physics</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pace</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Testing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/testing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing">
<h1>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h1>
<p>Savepoint tests are run automatically on every commit to the main branch.
Savepoint data are generated from <a class="reference external" href="https://github.com/ai2cm/fv3gfs-fortran/tree/master/tests/serialized_test_data_generation">fv3gfs-fortran</a> and can also be downloaded:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make get_test_data
<span class="gp">$ </span><span class="c1"># if you do not have access to the Google Cloud Storage bucket, use FTP:</span>
<span class="gp">$ </span>make <span class="nv">USE_FTP</span><span class="o">=</span>yes get_test_data
</pre></div>
</div>
<p>Savepoint data are used in the “translate” tests and in checkpointer tests.
Developers should be aware that the “translate” tests are an older, initial design of the test infrastructure which has grown organically and may be difficult to understand or modify, but currently covers smaller parts of the code not tested independently by the checkpointer tests.
In the long run we suggest increasing the number of checkpoints and adding new checkpointer tests, and eventually removing the translate tests, which are considered deprecated.</p>
<ol class="arabic">
<li><p>Individual translate tests</p>
<blockquote>
<div><p>These test at the module level such as <cite>c_sw</cite> and <cite>d_sw</cite>, and the translate logic is shared among dynamical core and physics.
Larger tests also exist such as <cite>translate_fvdynamics</cite> which tests a full acoustic time step.
Manual thresholds are set for each savepoint test. Curerntly, maximum threshold is applied to all variables within the test.
Additionally, a near-zero value can be specified for a variable to ignore values that are very close to zero.</p>
</div></blockquote>
</li>
<li><p>Checkpointer tests</p>
<blockquote>
<div><p>This tests the full model run where checkpoints are inserted throughout the model.
See <code class="docutils literal notranslate"><span class="pre">tests/savepoint/test_checkpoints.py</span></code> for an example.
Checkpointers are given model state along with a label, and may implement any behavior they wish.
For example, checkpointers have been written to:</p>
<ol class="arabic simple">
<li><p>compare the model state to a reference state (<a class="reference internal" href="util/api.html#pace.util.ValidationCheckpointer" title="pace.util.ValidationCheckpointer"><code class="xref py py-class docutils literal notranslate"><span class="pre">pace.util.ValidationCheckpointer</span></code></a>)</p></li>
<li><p>calibrate the threshold for each variable given a perturbed state (<a class="reference internal" href="util/api.html#pace.util.ThresholdCalibrationCheckpointer" title="pace.util.ThresholdCalibrationCheckpointer"><code class="xref py py-class docutils literal notranslate"><span class="pre">pace.util.ThresholdCalibrationCheckpointer</span></code></a>)</p></li>
</ol>
<p>Additional checkpoint behaviors could be implemented, for example to save reference test data directly from Python.
Thresholds are set automatically using a <a class="reference internal" href="util/api.html#pace.util.ThresholdCalibrationCheckpointer" title="pace.util.ThresholdCalibrationCheckpointer"><code class="xref py py-class docutils literal notranslate"><span class="pre">pace.util.ThresholdCalibrationCheckpointer</span></code></a> for each variable based on a round-off error perturbed initial state.
We run the model multiple times with a perturbed initial state and record the largest differences at each checkpoint for each variable.
The threshold is then set to the largest difference multiplied by a scaling factor.
Currently, only checkpoint tests within the dynamical core are tested.
There are two outstanding PRs to include driver and physics checkpoint tests.</p>
</div></blockquote>
</li>
</ol>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>While individual translate test can be run on all backends, checkpointer tests do not work for orchestrated DaCe backend.
This is a limitation due to DaCe not accepting keyword arguments or a list of <a class="reference internal" href="util/api.html#pace.util.Quantity" title="pace.util.Quantity"><code class="xref py py-class docutils literal notranslate"><span class="pre">pace.util.Quantity</span></code></a>, causing the checkpointer calls to be overly complicated.
A possible workaround is to follow the HaloUpdater example to wrap the variables at init time and called during DaCe callbacks.
A better solution would be to have DaCe accept a list of <a class="reference internal" href="util/api.html#pace.util.Quantity" title="pace.util.Quantity"><code class="xref py py-class docutils literal notranslate"><span class="pre">pace.util.Quantity</span></code></a>.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Translate tests for the dynamical core can be run as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make savepoint_tests
</pre></div>
</div>
<p>We suggest reading the Makefile for a full list of translate test targets. Checkpointer tests can be run as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make test_savepoint
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="util/index.html" class="btn btn-neutral float-right" title="pace-util" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="docker.html" class="btn btn-neutral float-left" title="Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, AI2 Climate Modeling Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>