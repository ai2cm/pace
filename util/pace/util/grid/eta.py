from dataclasses import dataclass

import numpy as np


@dataclass
class HybridPressureCoefficients:
    """
    Attributes:
     - ks: The number of pure-pressure layers at the top of the model
        Also the level where model transitions from pure pressure to
        hybrid pressure levels
     - ptop: The pressure at the top of the atmosphere
     - ak: The additive coefficient in the pressure calculation
     - bk: The multiplicative coefficient in the pressure calculation
    """

    ks: int
    ptop: int
    ak: np.ndarray
    bk: np.ndarray


def set_hybrid_pressure_coefficients(km: int) -> HybridPressureCoefficients:
    """
    Sets the coefficients describing the hybrid pressure coordinates.

    The pressure of each k-level is calculated as Pk = ak + (bk * Ps)
    where Ps is the surface pressure. Values are currently stored in
    lookup tables.

    Args:
        km: The number of vertical levels in the model

    Returns:
        a HybridPressureCoefficients dataclass
    """
    if km == 79:
        ak = np.array(
            [
                300,
                646.7159,
                1045.222,
                1469.188,
                1897.829,
                2325.385,
                2754.396,
                3191.294,
                3648.332,
                4135.675,
                4668.282,
                5247.94,
                5876.271,
                6554.716,
                7284.521,
                8066.738,
                8902.188,
                9791.482,
                10734.99,
                11626.25,
                12372.12,
                12990.41,
                13496.29,
                13902.77,
                14220.98,
                14460.58,
                14629.93,
                14736.33,
                14786.17,
                14785.11,
                14738.12,
                14649.66,
                14523.7,
                14363.82,
                14173.24,
                13954.91,
                13711.48,
                13445.4,
                13158.9,
                12854.07,
                12532.8,
                12196.85,
                11847.88,
                11487.39,
                11116.82,
                10737.48,
                10350.62,
                9957.395,
                9558.875,
                9156.069,
                8749.922,
                8341.315,
                7931.065,
                7519.942,
                7108.648,
                6698.281,
                6290.007,
                5884.984,
                5484.372,
                5089.319,
                4700.96,
                4320.421,
                3948.807,
                3587.201,
                3236.666,
                2898.237,
                2572.912,
                2261.667,
                1965.424,
                1685.079,
                1421.479,
                1175.419,
                947.6516,
                738.8688,
                549.713,
                380.7626,
                232.5417,
                105.481,
                -0.0008381903,
                0,
            ]
        )
        bk = np.array(
            [
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.001065947,
                0.004128662,
                0.009006631,
                0.01554263,
                0.02359921,
                0.03305481,
                0.0438012,
                0.05574095,
                0.06878554,
                0.08285347,
                0.09786981,
                0.1137643,
                0.130471,
                0.1479275,
                0.1660746,
                0.1848558,
                0.2042166,
                0.2241053,
                0.2444716,
                0.2652672,
                0.286445,
                0.3079604,
                0.3297701,
                0.351832,
                0.3741062,
                0.3965532,
                0.4191364,
                0.4418194,
                0.4645682,
                0.48735,
                0.5101338,
                0.5328897,
                0.5555894,
                0.5782067,
                0.6007158,
                0.6230936,
                0.6452944,
                0.6672683,
                0.6889648,
                0.7103333,
                0.7313231,
                0.7518838,
                0.7719651,
                0.7915173,
                0.8104913,
                0.828839,
                0.846513,
                0.8634676,
                0.8796583,
                0.8950421,
                0.9095779,
                0.9232264,
                0.9359506,
                0.9477157,
                0.9584892,
                0.9682413,
                0.9769447,
                0.9845753,
                0.9911126,
                0.9965372,
                1,
            ]
        )

    elif km == 91:

        ak = np.array(
            [
                1.00000000,
                1.75000000,
                2.75000000,
                4.09999990,
                5.98951054,
                8.62932968,
                12.2572632,
                17.1510906,
                23.6545467,
                32.1627693,
                43.1310921,
                57.1100426,
                74.6595764,
                96.4470978,
                123.169769,
                155.601318,
                194.594009,
                241.047531,
                295.873840,
                360.046967,
                434.604828,
                520.628723,
                619.154846,
                731.296021,
                858.240906,
                1001.06561,
                1160.92859,
                1339.03992,
                1536.50012,
                1754.48938,
                1994.17834,
                2256.67407,
                2543.17139,
                2854.76392,
                3192.58569,
                3557.75366,
                3951.35107,
                4374.28662,
                4827.11084,
                5310.22168,
                5823.87793,
                6369.04248,
                6948.75244,
                7566.91992,
                8226.34277,
                8931.20996,
                9684.46191,
                10482.2725,
                11318.2793,
                12184.0771,
                13065.5674,
                13953.2207,
                14830.7285,
                15687.2617,
                16508.0645,
                17281.0996,
                17994.2988,
                18636.3223,
                19196.1797,
                19664.0723,
                20030.1914,
                20285.3691,
                20421.5254,
                20430.0684,
                20302.8730,
                20032.3711,
                19611.0664,
                19031.3848,
                18286.6426,
                17377.7930,
                16322.4639,
                15144.4033,
                13872.5674,
                12540.4785,
                11183.4170,
                9835.32715,
                8526.30664,
                7282.24512,
                6123.26074,
                5063.50684,
                4111.24902,
                3270.00122,
                2539.22729,
                1915.30762,
                1392.44995,
                963.134766,
                620.599365,
                357.989502,
                169.421387,
                51.0314941,
                2.48413086,
                0.00000000,
            ]
        )

        bk = np.array(
            [
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                3.50123992e-06,
                2.81484008e-05,
                9.38666999e-05,
                2.28561999e-04,
                5.12343016e-04,
                1.04712998e-03,
                1.95625005e-03,
                3.42317997e-03,
                5.58632007e-03,
                8.65428988e-03,
                1.27844000e-02,
                1.81719996e-02,
                2.49934997e-02,
                3.34198996e-02,
                4.36249003e-02,
                5.57769015e-02,
                7.00351968e-02,
                8.65636021e-02,
                0.105520003,
                0.127051994,
                0.151319996,
                0.178477004,
                0.208675995,
                0.242069006,
                0.278813988,
                0.319043010,
                0.362558991,
                0.408596009,
                0.456384987,
                0.505111992,
                0.553902984,
                0.601903021,
                0.648333013,
                0.692534983,
                0.733981013,
                0.772292018,
                0.807236016,
                0.838724971,
                0.866774976,
                0.891497016,
                0.913065016,
                0.931702971,
                0.947658002,
                0.961175978,
                0.972495019,
                0.981844008,
                0.989410996,
                0.995342016,
                1.00000000,
            ]
        )

    elif km == 72:

        ak = np.array(
            [
                1.00000000,
                2.00000024,
                3.27000046,
                4.75850105,
                6.60000134,
                8.93450165,
                11.9703016,
                15.9495029,
                21.1349030,
                27.8526058,
                36.5041084,
                47.5806084,
                61.6779099,
                79.5134125,
                101.944023,
                130.051025,
                165.079025,
                208.497040,
                262.021057,
                327.643066,
                407.657104,
                504.680115,
                621.680115,
                761.984192,
                929.294189,
                1127.69019,
                1364.34021,
                1645.71033,
                1979.16040,
                2373.04053,
                2836.78052,
                3381.00073,
                4017.54102,
                4764.39111,
                5638.79102,
                6660.34131,
                7851.23145,
                9236.57227,
                10866.3018,
                12783.7031,
                15039.3027,
                17693.0039,
                20119.2012,
                21686.5020,
                22436.3008,
                22389.8008,
                21877.5977,
                21214.9980,
                20325.8984,
                19309.6953,
                18161.8965,
                16960.8965,
                15625.9961,
                14290.9951,
                12869.5938,
                11895.8623,
                10918.1709,
                9936.52148,
                8909.99219,
                7883.42188,
                7062.19824,
                6436.26367,
                5805.32129,
                5169.61084,
                4533.90088,
                3898.20093,
                3257.08081,
                2609.20068,
                1961.31055,
                1313.48035,
                659.375244,
                4.80482578,
                0.00000000,
            ]
        )

        bk = np.array(
            [
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                0.00000000,
                8.17541324e-09,
                6.96002459e-03,
                2.80100405e-02,
                6.37200624e-02,
                0.113602079,
                0.156224087,
                0.200350106,
                0.246741116,
                0.294403106,
                0.343381137,
                0.392891139,
                0.443740189,
                0.494590193,
                0.546304166,
                0.581041515,
                0.615818441,
                0.650634944,
                0.685899913,
                0.721165955,
                0.749378204,
                0.770637512,
                0.791946948,
                0.813303947,
                0.834660947,
                0.856018007,
                0.877429008,
                0.898908019,
                0.920387030,
                0.941865027,
                0.963406026,
                0.984951973,
                1.00000000,
            ]
        )

    else:
        raise NotImplementedError(
            "Only grids with 72, 79, or 91 vertical levels have been implemented so far"
        )
    if 0.0 in bk:
        ks = 0 if km == 91 else np.where(bk == 0)[0][-1]
        ptop = ak[0]
    else:
        raise ValueError("bk must contain at least one 0.")

    pressure_data = HybridPressureCoefficients(ks, ptop, ak, bk)
    return pressure_data
